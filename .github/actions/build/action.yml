name: 'Build application'
description: 'Build project and push to gcp registry'
inputs:
  project:
    description: "Project id (used for gcp)"
    required: true
  app-path:
    required: true
    description: "Application path"
  prefix-tag:
    required: false
    description: "Prefixed used in alpha for the tag image"
    default: ""
  gcp-registry:
    required: false
    description: "GCP registry name"
    default: "gcr.io"
  gcp-namespace:
    required: false
    description: "GCP namespace"
    default: "prestashop-cloud-integration"
  gcp-credentials:
    required: true
    description: "GCP services account credentials"
  release_version:
    required: false
    description: "Release version"

runs:
  using: "composite"
  steps:
    - name: Get tag
      shell: bash
      id: get_tag
      run: echo ::set-output name=TAG::$PREFIX_TAG$(echo $GITHUB_REF | cut -d / -f 3)
      env:
        PREFIX_TAG: ${{ inputs.prefix-tag }}
    - name: Build and push image
      shell: bash
      working-directory: ${{ inputs.app-path }}
      run: |
        docker buildx build \
          --cache-from="${GCLOUD_REGISTRY}/${GCLOUD_NAMESPACE}/testing-qanightly-migration/${GCLOUD_PROJECT}:latest" \
          --tag="${GCLOUD_REGISTRY}/${GCLOUD_NAMESPACE}/testing-qanightly-migration/${GCLOUD_PROJECT}:latest" \
          --tag="${GCLOUD_REGISTRY}/${GCLOUD_NAMESPACE}/testing-qanightly-migration/${GCLOUD_PROJECT}:${TAG}" .
        docker push "${GCLOUD_REGISTRY}/${GCLOUD_NAMESPACE}/testing-qanightly-migration/${GCLOUD_PROJECT}:${TAG}"
        docker push "${GCLOUD_REGISTRY}/${GCLOUD_NAMESPACE}/testing-qanightly-migration/${GCLOUD_PROJECT}:latest"
      env:
        APP_PATH: ${{ inputs.app-path }}
        GCLOUD_REGISTRY: ${{ inputs.gcp-registry }}
        GCLOUD_NAMESPACE: ${{ inputs.gcp-namespace }}
        GCLOUD_PROJECT: ${{ inputs.project }}
        RELEASE_VERSION: ${{ inputs.release_version }}
        TAG: ${{ steps.get_tag.outputs.TAG }}
